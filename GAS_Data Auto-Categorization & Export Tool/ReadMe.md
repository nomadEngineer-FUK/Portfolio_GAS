# Data Auto-Categorization & Export Tool

## 概要

この Google Apps Script（GAS）プロジェクトは、Google Drive 上の Excel ファイルや Google スプレッドシートから最新のデータを自動的に読み込み、定義された条件に基づいてデータを「連携」「連携対象外」「休会」の 3 つのカテゴリに自動分類し、その結果を新しい Google スプレッドシートとして Google Drive 上の指定フォルダに出力するツールです。日々の定型的なデータ処理作業を効率化し、手作業によるミスを削減することを目的としています。

Excel ファイルが指定された場合でも、Google スプレッドシート形式に一時的に変換して処理を行うため、様々な形式のデータソースに対応可能です。

## 主な機能

- **多様なデータソース対応**: Excel ファイル（.xlsx, .xls）および Google スプレッドシートに対応。
- **最新シートの自動判別**: シート名が`yymmdd`形式のシートの中から最新の日付のシートを自動的に判別し、処理対象とします。
- **データ自動分類**: 読み込んだデータを行ごとに指定された条件に基づき、「連携」「連携対象外」「休会」の 3 カテゴリに分類します。
- **結果の自動出力**: 分類されたデータを元に、新しい Google スプレッドシートを作成し、指定された Google Drive フォルダに保存します。
- **ログ記録と通知**: 処理の成功/失敗、および作成されたファイルの URL などをログシートに記録し、UI でユーザーに通知します。
- **一時ファイルの自動削除**: Excel ファイル変換時に生成される一時的な Google スプレッドシートは、処理完了後に自動でゴミ箱に移動されます。

## 動作環境

- Google Workspace アカウント
- Google Apps Script (GAS)
- Google Drive API (v2) - GAS プロジェクトでサービスを有効にする必要があります。

## セットアップ

### 1. スクリプトファイルの準備

1.  新しい Google スプレッドシートを作成します。このスプレッドシートがスクリプトのホストファイルとなります。
2.  スプレッドシートを開き、「拡張機能」>「Apps Script」を選択して Apps Script エディタを開きます。
3.  既存のコードをすべて削除し、提供された GAS コード（`mainProcessData`関数とそのヘルパー関数群）を貼り付けます。
4.  GAS プロジェクトに適切な名前を付けます（例: `DataAutoProcessor`）。

### 2. 必要な Google サービスを有効にする

1.  Apps Script エディタの左側メニューで「サービス」の横にある「＋」アイコンをクリックします。
2.  「**Drive API**」を探してクリックし、「追加」ボタンをクリックします。(バージョンは `v2` を想定しています)

### 3. 設定シートの作成と設定

スクリプトホストスプレッドシート内に、以下の設定を持つシートを作成する必要があります。

1.  シート名を `設定` (またはコード内で定義されている `CONFIG_SHEET_NAME` の値) に変更します。
2.  以下の情報を B 列に入力します。
    - **B1 セル**: 読み取り対象となる Excel ファイルまたは Google スプレッドシートの URL
      - 例: `https://docs.google.com/spreadsheets/d/xxxxxxxxxxxxxxxxxxxxxxxxx/edit`
      - 例: `https://docs.google.com/spreadsheets/d/xxxxxxxxxxxxxxxxxxxxxxxxx/edit?usp=sharing` (Excel ファイルの場合も Google Drive の共有リンクを使用)
    - **B2 セル**: 出力先とする Google Drive フォルダの URL
      - 例: `https://drive.google.com/drive/folders/xxxxxxxxxxxxxxxxxxxxxxxxx`

### 4. 実行

1.  Apps Script エディタに戻り、関数ドロップダウンから `mainProcessData` を選択します。
2.  再生ボタン（▶️）をクリックしてスクリプトを実行します。
3.  初回実行時には、Google アカウントへの認証が求められます。指示に従ってアクセスを許可してください。

## 処理フロー

1.  **設定の読み込み**: `設定`シートから、読み取り対象ファイルの URL と出力先フォルダの URL を読み込みます。
2.  **ソースデータの準備**:
    - 指定されたファイルが Excel の場合、一時的に Google スプレッドシート形式に変換します。
    - 変換された（または元の）スプレッドシートから、シート名が`yymmdd`形式のシートを検索し、最新の日付のシートを特定します。
    - 特定されたシートのデータを読み込み、処理に必要な列（`ID`, `STUDENT_CODE`, `ACTION_TYPE`など）のインデックスを特定します。
3.  **データ加工**: 読み込んだデータを行ごとに評価し、「連携」「連携対象外」「休会」の 3 つのカテゴリに分類します。この分類ロジックはスクリプト内で定義されています。
4.  **結果の出力**: 分類されたデータに基づき、新しい Google スプレッドシートを作成します。シート名は読み取った`yymmdd`形式のシート名が使用されます。新しいスプレッドシートは指定された出力先フォルダに保存されます。
5.  **ログ記録と通知**: 処理結果（成功/失敗、作成されたファイルの URL など）は、スクリプトホストスプレッドシートのログシートに記録され、処理の完了をユーザーに UI アラートで通知します。
6.  **クリーンアップ**: Excel ファイル変換時に作成された一時スプレッドシートは、処理終了後に自動的にゴミ箱に移動されます。

## エラーハンドリング

スクリプトは、以下のような様々なエラーケースに対応しています。

- 設定シートや設定値の不足/誤り
- 指定されたファイルやフォルダへのアクセス権不足
- Excel ファイルの変換失敗
- 対象シートの欠落や必要な列の不足
- 予期せぬスクリプトエラー

エラー発生時には、ユーザーへのアラート表示と詳細なログ記録が行われます。

## 開発者向け情報

### 定数 (Constants)

コード内で定義されている定数（例: `CONFIG_SHEET_NAME`, `SOURCE_FILE_URL_CELL`, `OUTPUT_FOLDER_URL_CELL`, `TARGET_COLUMNS`など）は、スクリプトの動作を調整するために使用されます。これらの値は、必要に応じて変更することができます。

### 主要関数

- `mainProcessData()`: 全体の処理フローを制御するメイン関数。
- `getConfigSheetOrAlert_()`: 設定シートを取得し、存在しない場合はアラートを表示。
- `loadAndValidateSettings_()`: 設定シートから設定を読み込み、検証。
- `getOutputFolderFromSettings_()`: 出力先フォルダの情報を取得し、検証。
- `getSourceFileInfoFromSettings_()`: 読み取り対象ファイルの情報を取得し、検証。
- `prepareSourceSpreadsheet_()`: ソースファイルをスプレッドシートとして準備（Excel の場合は変換）。
- `prepareSourceData_()`: 読み取り対象のシートとデータを準備。
- `processData_()`: データを分類・加工する核心ロジック。
- `createAndPopulateOutputSpreadsheet_()`: 分類されたデータを出力スプレッドシートに書き込む。
- `logExecution_()`: 実行ログを記録する。
- `showErrorAlert()`: エラーアラートをユーザーに表示する。
- `getRequiredSettingOrAlert_()`: 必須設定値を取得し、不足時はアラート。
- `getLatestTargetSheet_()`: `yymmdd`形式の最新シートを取得。
- `getColumnIndices_()`: ヘッダーから必要な列のインデックスを取得。

---
